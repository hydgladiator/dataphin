---
keyword: [质量规则, 设置告警, 新建分区表达式, 配置质量规则]
---

# 创建校验数据表的质量规则

为了提升数据表质量监控的便捷性，Dataphin支持创建校验数据表的质量规则。数据表参与质量规则校验时，如果触发了质量监控规则，系统会给您发送告警消息，便于您及时发现并处理异常。本文为您介绍如何配置数据表的质量规则。

已发布数据表至生产环境。如何发布数据表至生产环境，请参见[管理发布任务](/cn.zh-CN/任务发布/管理发布任务.md)。

## 操作流程

|功能|描述|
|--|--|
|[步骤一：选择数据表](#section_1z4_avb_zf0)|选择需要创建质量规则的数据表。|
|[步骤二：设置告警](#section_sfw_m4m_kcu)|添加告警信息接收人。如果触发了质量监控规则，系统会给您发送告警消息，便于您及时发现并处理异常。|
|[步骤三：创建分区表达式](#section_gw2_zvz_1ji)|定义数据表质量检验的分区数据，避免全表扫描。|
|[步骤四：配置质量规则](#section_ui8_88n_g82)|配置分区表达式下的数据表的质量校验规则。|
|[步骤五：试跑规则](#section_yh6_cgt_6ik)|测试质量规则运行结果是否正确。|
|[步骤六：打开校验开关](#section_xs5_2n8_tpr)|质量检验开关打开后，质量校验规则即可生效。|

## 步骤一：选择数据表

1.  登录[Dataphin控制台](https://dataphin.console.aliyun.com/workingArea)。

2.  在Dataphin控制台页面，选择工作区地域后，单击**进入Dataphin\>\>**。

3.  在Dataphin首页，单击顶部菜单栏中的**资产**。

4.  在数据**资产**页面，单击顶部菜单栏的**质量**。

5.  在数据**质量**页面，单击左侧导航栏的**数据表规则**。

6.  在**数据表规则**页面，单击**新建质量规则**。

7.  在**新建质量规则**对话框，选择数据表后单击**开始配置**。

    您也可以选择业务板块、所属项目和表类型筛选数据表。


## 步骤二：设置告警

1.  单击**告警设置**后的![fagag](https://help-static-aliyun-doc.aliyuncs.com/assets/img/zh-CN/2867528951/p84203.png)图标。

2.  在**告警设置**对话框，选择**告警接收人**及**告警方式**后，单击**确定**。


## 步骤三：创建分区表达式

分区表达式用于限定一组质量规则的作用范围。数据表可以有多个分区表达式，每个分区表达式下可以配置多个质量规则，如下图所示。

![gaga](https://help-static-aliyun-doc.aliyuncs.com/assets/img/zh-CN/1129997951/p84268.png)

1.  单击**质量规则配置**后的**新建分区表达式**。

2.  在**新建分区表达式**对话框，选择**分区表达式类型**并填写分区表达式后，单击**保存**。

    -   如果您选择的是非分区表达式类型，则表达式为`ds=NONE`。
    -   如果您选择的是**自定义**，则需您手动填写系统支持的分区表达式，例如`ds=${yyyyMM01}`。

        系统支持的分区及表达式说明如下。

        |分区|表达式|
        |--|---|
        |**最近一天**|`ds='${yyyyMMdd}'`。|
        |**本周第一天**|`ds=tdBeginDate('${yyyyMMdd}', 'w', 'yyyyMMdd')`。|
        |**本周最后一天**|`ds=customEndDate('${yyyyMMdd}', 'w', '1', 0, 'yyyyMMdd')`。|
        |**本月第一天**|`ds=tdBeginDate('${yyyyMMdd}', 'm', 'yyyyMMdd')`。|
        |**本月最后一天**|`ds=customEndDate('${yyyyMMdd}', 'm', '01', 0, 'yyyyMMdd')`。|
        |**本季度第一天**|`ds=tdBeginDate('${yyyyMMdd}', 'q', 'yyyyMMdd')`。|
        |**本季度最后一天**|`ds=customEndDate('${yyyyMMdd}', 'q', '0101', 0, 'yyyyMMdd')`。|
        |**本年第一天**|`ds=tdBeginDate('${yyyyMMdd}', 'y', 'yyyyMMdd')`。|
        |**本年最后一天**|`ds=customEndDate('${yyyyMMdd}', 'y', '0101', 0, 'yyyyMMdd')`。|
        |**上月第一天**|`ds=cBeginDate('${yyyyMMdd}', 'm', 'yyyyMMdd')`。|
        |**上月最后一天**|`ds=cEndDate('${yyyyMMdd}', 'm', 'yyyyMMdd')`。|
        |**所有分区**|`ds=ALL`。|

    同时您也可以对已添加的分区表达式执行如下操作：

    -   单击**分区表达式**后的![gaga](https://help-static-aliyun-doc.aliyuncs.com/assets/img/zh-CN/1129997951/p84327.png)图标，编辑分区表达式。
    -   单击**分区表达式**后的![gaga](https://help-static-aliyun-doc.aliyuncs.com/assets/img/zh-CN/2129997951/p84328.png)图标，删除分区表达式。

## 步骤四：配置质量规则

1.  单击**分区表达式**后的**新建质量规则**。

2.  在**新建规则**对话框，配置参数后单击**保存**。

    规则类型包括**质量模板规则**和**自定义规则**：

    -   如果**规则类型**选择了**质量模板规则**。

        ![gaga](https://help-static-aliyun-doc.aliyuncs.com/assets/img/zh-CN/2129997951/p84336.png)

        |参数|描述|
        |--|--|
        |**对象名称**|选择质量规则校验的对象。**对象名称**包括`表：表名称`和`字段：表所包含的字段`。|
        |**规则强度**|选择质量规则的强弱：         -   如果您选择了**强规则**，则质量规则校验的结果为异常时报警并阻塞下游任务节点。
        -   如果您选择了**弱规则**，则质量规则校验的结果为异常时报警但不阻塞下游任务节点。 |
        |**模板类型**|选择质量规则校验的维度。根据质量规则校验对象的类型，系统会自动为您呈现对应校验模板的类型，详情请参见[表 1](#table_8vq_02k_pa6)。|
        |**趋势**|        -   如果校验类型为波动型，则**趋势**包括**绝对值**、**向上**、**向下**。
        -   如果校验类型为对比型，则**趋势**为**固定值**。
详情请参见[表 1](#table_8vq_02k_pa6)。|
        |**对比设置**|设定质量规则校验结果与目标值的对比规则。**对比规则**包括**大于目标值**、**大于等于目标值**、**等于目标值**、**小于目标值**和**小于等于目标值**，且需要设置**对比规则**对应的**目标值**。|
        |**波动阈值**|设定质量规则校验结果的**波动阈值**，波动监测阈值设定在对比值基础上的0~10倍率的范围内。|

        |对象名称|模板类型|趋势|配置项|校验类型|
        |----|----|--|---|----|
        |`表：表名称`|表/分区大小1天波动检测|绝对值、向上、向下|波动阈值|波动型|
        |`表：表名称`|表/分区行数1天波动检测|绝对值、向上、向下|波动阈值|波动型|
        |`表：表名称`|表/分区大小7天波动检测|绝对值、向上、向下|波动阈值|波动型|
        |`表：表名称`|表/分区行数7天波动检测|绝对值、向上、向下|波动阈值|波动型|
        |`表：表名称`|表/分区行数30天波动检测|绝对值、向上、向下|波动阈值|波动型|
        |`表：表名称`|表/分区行数1，7，30天波动检测|绝对值、向上、向下|波动阈值|波动型|
        |`表：表名称`|表/分区行数大小7天平均波动检测|绝对值、向上、向下|波动阈值|波动型|
        |`表：表名称`|表/分区行数30天对比|绝对值、向上、向下|波动阈值|波动型|
        |`表：表名称`|表分区数|固定值|对比设置|对比型|
        |`表：表名称`|表分区数波动检测|绝对值、向上、向下|波动阈值|波动型|
        |`表：表名称`|表/分区行数1，7，30，本月1号分区波动检测|绝对值、向上、向下|波动阈值|波动型|
        |`字段：表所包含的字段名称`|字段唯一值个数期望校验|固定值|对比设置|对比型|
        |`字段：表所包含的字段名称`|字段唯一值1，7，30天波动检测|绝对值、向上、向下|波动阈值|波动型|
        |`字段：表所包含的字段名称`|字段平均值1，7，30天波动检测|绝对值、向上、向下|波动阈值|波动型|
        |`字段：表所包含的字段名称`|字段最大值1天波动检测|绝对值、向上、向下|波动阈值|波动型|
        |`字段：表所包含的字段名称`|字段最大值1，7，30天波动检测|绝对值、向上、向下|波动阈值|波动型|
        |`字段：表所包含的字段名称`|字段最小值1天波动检测|绝对值、向上、向下|波动阈值|波动型|
        |`字段：表所包含的字段名称`|字段最小值1，7，30天波动检测|绝对值、向上、向下|波动阈值|波动型|
        |`字段：表所包含的字段名称`|字段汇总值1天波动检测|绝对值、向上、向下|波动阈值|波动型|
        |`字段：表所包含的字段名称`|字段汇总值1，7，30天波动检测|绝对值、向上、向下|波动阈值|波动型|
        |`字段：表所包含的字段名称`|字段空值个数|固定值|对比设置|对比型|
        |`字段：表所包含的字段名称`|空值率（字段空值个数/行数）|固定值|对比设置|对比型|
        |`字段：表所包含的字段名称`|字段重复个数|固定值|对比设置|对比型|
        |`字段：表所包含的字段名称`|重复率（字段重复个数/总行数）|固定值|对比设置|对比型|

    -   如果**规则类型**选择了**自定义规则**。

        ![gaga](https://help-static-aliyun-doc.aliyuncs.com/assets/img/zh-CN/2129997951/p84337.png)

        |参数|描述|
        |--|--|
        |**规则名称**|填写规则名称。|
        |**规则内容**|填写质量规则校验的内容，例如。         ```
select
  sum(value) as metric
from
  current_table ctb
  left outer join related_table rtb on ctb.id = rtb.id
where
  ds = ${bizdate};
        ```

代码编写完成后，单击**规范性校验**系统帮助您校验代码的语法格式。您也单击**格式化**系统自动为您调整代码的格式。 |
        |**规则强度**|选择质量规则的强弱：         -   如果您选择了**强规则**，则质量规则校验的结果为异常时报警并阻塞下游任务节点。
        -   如果您选择了**弱规则**，则质量规则校验的结果为异常时报警但不阻塞下游任务节点。 |
        |**检测类型**|选择质量规则校验的类型。**检测类型**包括**1天波动**、**7天波动**、**7天平均值波动**、**30天平均值波动**、**对比固定值**。|
        |**趋势**|        -   如果校验类型为波动型，则**趋势**包括**绝对值**、**向上**、**向下**。
        -   如果校验类型为对比型，则**趋势**为**固定值**。 |
        |**对比设置**|选择质量规则校验的结果与目标值的**对比规则**和**目标值**。**对比规则**包括**大于目标值**、**大于等于目标值**、**等于目标值**、**小于目标值**和**小于等于目标值**，且需要设置**对比规则**对应的**目标值**。**说明：** 当**检测类型**为**对比固定值**时，显示**对比设置**。 |
        |**波动阈值**|设定质量规则校验结果的**波动阈值**，波动监测阈值设定允许范围为0.0~10.0。**说明：** 当**检测类型**为**1天波动**、**7天波动**、**7天平均值波动**或**30天平均值波动**时，显示**波动阈值**。 |


## 步骤五：试跑规则

选中新增的数据表规则，单击**规则试跑**。

![gagaga](https://help-static-aliyun-doc.aliyuncs.com/assets/img/zh-CN/3003963061/p175954.png)

如果数据表规则的试跑失败，则鼠标悬停至![gegaga](https://help-static-aliyun-doc.aliyuncs.com/assets/img/zh-CN/1114633061/p175621.png)图标，单击**试跑日志**，查看日志，定位试跑失败原因。

## 步骤六：打开校验开关

打开**校验开关**，即可根据数据表规则定义的频率和生效时间扫描数据表。

![vaaa](https://help-static-aliyun-doc.aliyuncs.com/assets/img/zh-CN/3003963061/p175955.png)

同时，您也可以在**数据表规则列表**页面，单击![geagag](https://help-static-aliyun-doc.aliyuncs.com/assets/img/zh-CN/1114633061/p175626.png)或![fagaga](https://help-static-aliyun-doc.aliyuncs.com/assets/img/zh-CN/1114633061/p175628.png)图标，关闭或打开数据表规则，即可开启或关闭该数据表的质量校验规则。

![gagG](https://help-static-aliyun-doc.aliyuncs.com/assets/img/zh-CN/1561329061/p175956.png)

